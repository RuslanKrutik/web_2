{% extends "chat_base.html" %}

{% block lab %}Чат{% endblock %}

{% block chat_window %}
<div class="chat-container">
    <!-- Список пользователей -->
    <div class="sidebar">
        <h2>Собеседники</h2>
        <ul id="user-list" class="user-list"></ul>
    </div>

    <!-- Окно чата -->
    <div class="chat-window">
        <div class="chat-header">
            <h3 id="chat-with">Выберите собеседника</h3>
        </div>
        <div id="message-list" class="message-list"></div>
        <div class="chat-input">
            <input type="text" id="message-input" placeholder="Введите сообщение" />
            <button onclick="sendMessage()">Отправить</button>
        </div>
    </div>
</div>

<script>
function loadUsers() {
    const url = '/json-rpc-api/';
    const token = sessionStorage.getItem('token');

    if (!token) {
        alert('Вы не авторизованы.');
        return;
    }

    const json = {
        'jsonrpc': '2.0',
        'method': 'get_users',
        'params': { 'token': token },
        'id': Math.round(Math.random() * 1000)
    };

    fetch(url, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(json)
    })
    .then(response => response.json())
    .then(data => {
        if (data.error) {
            alert(`Ошибка загрузки пользователей: ${data.error.message}`);
        } else {
            const usersList = data.result.users;
            const userListContainer = document.getElementById('user-list');
            userListContainer.innerHTML = '';

            usersList.forEach(user => {
                const li = document.createElement('li');
                li.innerHTML = `<div class="user-icon">${user.username[0]}</div>${user.username}`;
                li.onclick = () => {
                    sessionStorage.setItem('chatWith', user.id);
                    sessionStorage.setItem('chatWithName', user.username);
                    loadMessages();
                    document.getElementById('chat-with').textContent = user.username;
                };
                userListContainer.appendChild(li);
            });
        }
    });
}

function loadMessages() {
    const url = '/json-rpc-api/';
    const token = sessionStorage.getItem('token');
    const chatWith = sessionStorage.getItem('chatWith');

    if (!token || !chatWith) {
        alert('Ошибка авторизации или ID чата.');
        return;
    }

    const json = {
        'jsonrpc': '2.0',
        'method': 'get_messages',
        'params': { 'token': token, 'chat_with': parseInt(chatWith) },
        'id': Math.round(Math.random() * 1000)
    };

    fetch(url, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(json)
    })
    .then(response => response.json())
    .then(data => {
        if (data.error) {
            alert(`Ошибка загрузки сообщений: ${data.error.message}`);
        } else {
            const messages = data.result.messages;
            const messageList = document.getElementById('message-list');
            messageList.innerHTML = '';

            messages.forEach(message => {
                const div = document.createElement('div');
                div.classList.add('message');
                if (message.sender_id === parseInt(sessionStorage.getItem('chatWith'))) {
                    div.classList.add('message-sender');
                } else {
                    div.classList.add('message-receiver');
                }
                div.innerText = message.text;
                messageList.appendChild(div);
            });
        }
    });
}

function sendMessage() {
    const url = '/json-rpc-api/';
    const token = sessionStorage.getItem('token');
    const chatWith = sessionStorage.getItem('chatWith');
    const text = document.getElementById('message-input').value;

    if (!token || !chatWith || !text) {
        alert('Ошибка отправки сообщения.');
        return;
    }

    const json = {
        'jsonrpc': '2.0',
        'method': 'send_message',
        'params': { 'token': token, 'receiver_id': parseInt(chatWith), 'text': text },
        'id': Math.round(Math.random() * 1000)
    };

    fetch(url, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(json)
    })
    .then(response => response.json())
    .then(data => {
        if (data.error) {
            alert(`Ошибка отправки сообщения: ${data.error.message}`);
        } else {
            document.getElementById('message-input').value = '';
            loadMessages();
        }
    });
}

document.addEventListener('DOMContentLoaded', () => {
    loadUsers();
    const chatWithName = sessionStorage.getItem('chatWithName');
    if (chatWithName) {
        document.getElementById('chat-with').textContent = chatWithName;
        loadMessages();
    }
});
</script>
{% endblock %}